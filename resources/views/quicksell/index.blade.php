@section('page_name')
Quick Sale
@stop

@section('breadcrumbs')
Quick Sale
@stop

@section('scripts')
<script src='/js/ui-select.js'></script>
<script src='data:application/octet-stream;base64,LyoKIEFuZ3VsYXJKUyB2MS41LjAtYmV0YS4xCiAoYykgMjAxMC0yMDE1IEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogTGljZW5zZTogTUlUCiovCihmdW5jdGlvbih5LGYseil7J3VzZSBzdHJpY3QnO2Z1bmN0aW9uIEEoYSl7dmFyIGQ9W107dChkLGYubm9vcCkuY2hhcnMoYSk7cmV0dXJuIGQuam9pbigiIil9ZnVuY3Rpb24gZyhhLGQpe3ZhciBiPXt9LGM9YS5zcGxpdCgiLCIpLGs7Zm9yKGs9MDtrPGMubGVuZ3RoO2srKyliW2Q/Zi5sb3dlcmNhc2UoY1trXSk6Y1trXV09ITA7cmV0dXJuIGJ9ZnVuY3Rpb24gQihhLGQpe251bGw9PT1hfHxhPT09ej9hPSIiOiJzdHJpbmciIT09dHlwZW9mIGEmJihhPSIiK2EpO2UuaW5uZXJIVE1MPWE7dmFyIGI9NTtkb3tpZigwPT09Yil0aHJvdyB1KCJ1aW5wdXQiKTtiLS07MTE+PWRvY3VtZW50LmRvY3VtZW50TW9kZSYmbihlKTthPWUuaW5uZXJIVE1MO2UuaW5uZXJIVE1MPWF9d2hpbGUoYSE9PWUuaW5uZXJIVE1MKTtmb3IoYj1lLmZpcnN0Q2hpbGQ7Yjspe3N3aXRjaChiLm5vZGVUeXBlKXtjYXNlIDE6ZC5zdGFydChiLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksQyhiLmF0dHJpYnV0ZXMpKTsKYnJlYWs7Y2FzZSAzOmQuY2hhcnMoYi50ZXh0Q29udGVudCl9dmFyIGM7aWYoIShjPWIuZmlyc3RDaGlsZCkmJigxPT1iLm5vZGVUeXBlJiZkLmVuZChiLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpLGM9Yi5uZXh0U2libGluZywhYykpZm9yKDtudWxsPT1jOyl7Yj1iLnBhcmVudE5vZGU7aWYoYj09PWUpYnJlYWs7Yz1iLm5leHRTaWJsaW5nOzE9PWIubm9kZVR5cGUmJmQuZW5kKGIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSl9Yj1jfWZvcig7Yj1lLmZpcnN0Q2hpbGQ7KWUucmVtb3ZlQ2hpbGQoYil9ZnVuY3Rpb24gQyhhKXtmb3IodmFyIGQ9e30sYj0wLGM9YS5sZW5ndGg7YjxjO2IrKyl7dmFyIGs9YVtiXTtkW2submFtZV09ay52YWx1ZX1yZXR1cm4gZH1mdW5jdGlvbiB2KGEpe3JldHVybiBhLnJlcGxhY2UoLyYvZywiJmFtcDsiKS5yZXBsYWNlKEQsZnVuY3Rpb24oYSl7dmFyIGI9YS5jaGFyQ29kZUF0KDApO2E9YS5jaGFyQ29kZUF0KDEpO3JldHVybiImIyIrKDEwMjQqKGItNTUyOTYpKwooYS01NjMyMCkrNjU1MzYpKyI7In0pLnJlcGxhY2UoRSxmdW5jdGlvbihhKXtyZXR1cm4iJiMiK2EuY2hhckNvZGVBdCgwKSsiOyJ9KS5yZXBsYWNlKC88L2csIiZsdDsiKS5yZXBsYWNlKC8+L2csIiZndDsiKX1mdW5jdGlvbiB0KGEsZCl7dmFyIGI9ITEsYz1mLmJpbmQoYSxhLnB1c2gpO3JldHVybntzdGFydDpmdW5jdGlvbihhLGUpe2E9Zi5sb3dlcmNhc2UoYSk7IWImJkdbYV0mJihiPWEpO2J8fCEwIT09clthXXx8KGMoIjwiKSxjKGEpLGYuZm9yRWFjaChlLGZ1bmN0aW9uKGIsZSl7dmFyIGc9Zi5sb3dlcmNhc2UoZSksRj0iaW1nIj09PWEmJiJzcmMiPT09Z3x8ImJhY2tncm91bmQiPT09ZzshMCE9PUhbZ118fCEwPT09d1tnXSYmIWQoYixGKXx8KGMoIiAiKSxjKGUpLGMoJz0iJyksYyh2KGIpKSxjKCciJykpfSksYygiPiIpKX0sZW5kOmZ1bmN0aW9uKGEpe2E9Zi5sb3dlcmNhc2UoYSk7Ynx8ITAhPT1yW2FdfHwhMD09PXhbYV18fChjKCI8LyIpLGMoYSksYygiPiIpKTthPT0KYiYmKGI9ITEpfSxjaGFyczpmdW5jdGlvbihhKXtifHxjKHYoYSkpfX19ZnVuY3Rpb24gbihhKXtpZihhLm5vZGVUeXBlPT09Tm9kZS5FTEVNRU5UX05PREUpZm9yKHZhciBkPWEuYXR0cmlidXRlcyxiPTAsYz1kLmxlbmd0aDtiPGM7YisrKXt2YXIgZj1kW2JdLGU9Zi5uYW1lLnRvTG93ZXJDYXNlKCk7aWYoInhtbG5zOm5zMSI9PT1lfHwwPT09ZS5pbmRleE9mKCJuczE6IikpYS5yZW1vdmVBdHRyaWJ1dGVOb2RlKGYpLGItLSxjLS19KGQ9YS5maXJzdENoaWxkKSYmbihkKTsoZD1hLm5leHRTaWJsaW5nKSYmbihkKX12YXIgdT1mLiQkbWluRXJyKCIkc2FuaXRpemUiKSxEPS9bXHVEODAwLVx1REJGRl1bXHVEQzAwLVx1REZGRl0vZyxFPS8oW15cIy1+IHwhXSkvZyx4PWcoImFyZWEsYnIsY29sLGhyLGltZyx3YnIiKSxoPWcoImNvbGdyb3VwLGRkLGR0LGxpLHAsdGJvZHksdGQsdGZvb3QsdGgsdGhlYWQsdHIiKSxtPWcoInJwLHJ0Iikscz1mLmV4dGVuZCh7fSxtLGgpLGg9Zi5leHRlbmQoe30sCmgsZygiYWRkcmVzcyxhcnRpY2xlLGFzaWRlLGJsb2NrcXVvdGUsY2FwdGlvbixjZW50ZXIsZGVsLGRpcixkaXYsZGwsZmlndXJlLGZpZ2NhcHRpb24sZm9vdGVyLGgxLGgyLGgzLGg0LGg1LGg2LGhlYWRlcixoZ3JvdXAsaHIsaW5zLG1hcCxtZW51LG5hdixvbCxwcmUsc2VjdGlvbix0YWJsZSx1bCIpKSxtPWYuZXh0ZW5kKHt9LG0sZygiYSxhYmJyLGFjcm9ueW0sYixiZGksYmRvLGJpZyxicixjaXRlLGNvZGUsZGVsLGRmbixlbSxmb250LGksaW1nLGlucyxrYmQsbGFiZWwsbWFwLG1hcmsscSxydWJ5LHJwLHJ0LHMsc2FtcCxzbWFsbCxzcGFuLHN0cmlrZSxzdHJvbmcsc3ViLHN1cCx0aW1lLHR0LHUsdmFyIikpLEk9ZygiY2lyY2xlLGRlZnMsZGVzYyxlbGxpcHNlLGZvbnQtZmFjZSxmb250LWZhY2UtbmFtZSxmb250LWZhY2Utc3JjLGcsZ2x5cGgsaGtlcm4saW1hZ2UsbGluZWFyR3JhZGllbnQsbGluZSxtYXJrZXIsbWV0YWRhdGEsbWlzc2luZy1nbHlwaCxtcGF0aCxwYXRoLHBvbHlnb24scG9seWxpbmUscmFkaWFsR3JhZGllbnQscmVjdCxzdG9wLHN2Zyxzd2l0Y2gsdGV4dCx0aXRsZSx0c3Bhbix1c2UiKSwKRz1nKCJzY3JpcHQsc3R5bGUiKSxyPWYuZXh0ZW5kKHt9LHgsaCxtLHMpLHc9ZygiYmFja2dyb3VuZCxjaXRlLGhyZWYsbG9uZ2Rlc2Msc3JjLHVzZW1hcCx4bGluazpocmVmIikscz1nKCJhYmJyLGFsaWduLGFsdCxheGlzLGJnY29sb3IsYm9yZGVyLGNlbGxwYWRkaW5nLGNlbGxzcGFjaW5nLGNsYXNzLGNsZWFyLGNvbG9yLGNvbHMsY29sc3Bhbixjb21wYWN0LGNvb3JkcyxkaXIsZmFjZSxoZWFkZXJzLGhlaWdodCxocmVmbGFuZyxoc3BhY2UsaXNtYXAsbGFuZyxsYW5ndWFnZSxub2hyZWYsbm93cmFwLHJlbCxyZXYscm93cyxyb3dzcGFuLHJ1bGVzLHNjb3BlLHNjcm9sbGluZyxzaGFwZSxzaXplLHNwYW4sc3RhcnQsc3VtbWFyeSx0YWJpbmRleCx0YXJnZXQsdGl0bGUsdHlwZSx2YWxpZ24sdmFsdWUsdnNwYWNlLHdpZHRoIiksbT1nKCJhY2NlbnQtaGVpZ2h0LGFjY3VtdWxhdGUsYWRkaXRpdmUsYWxwaGFiZXRpYyxhcmFiaWMtZm9ybSxhc2NlbnQsYmFzZVByb2ZpbGUsYmJveCxiZWdpbixieSxjYWxjTW9kZSxjYXAtaGVpZ2h0LGNsYXNzLGNvbG9yLGNvbG9yLXJlbmRlcmluZyxjb250ZW50LGN4LGN5LGQsZHgsZHksZGVzY2VudCxkaXNwbGF5LGR1cixlbmQsZmlsbCxmaWxsLXJ1bGUsZm9udC1mYW1pbHksZm9udC1zaXplLGZvbnQtc3RyZXRjaCxmb250LXN0eWxlLGZvbnQtdmFyaWFudCxmb250LXdlaWdodCxmcm9tLGZ4LGZ5LGcxLGcyLGdseXBoLW5hbWUsZ3JhZGllbnRVbml0cyxoYW5naW5nLGhlaWdodCxob3Jpei1hZHYteCxob3Jpei1vcmlnaW4teCxpZGVvZ3JhcGhpYyxrLGtleVBvaW50cyxrZXlTcGxpbmVzLGtleVRpbWVzLGxhbmcsbWFya2VyLWVuZCxtYXJrZXItbWlkLG1hcmtlci1zdGFydCxtYXJrZXJIZWlnaHQsbWFya2VyVW5pdHMsbWFya2VyV2lkdGgsbWF0aGVtYXRpY2FsLG1heCxtaW4sb2Zmc2V0LG9wYWNpdHksb3JpZW50LG9yaWdpbixvdmVybGluZS1wb3NpdGlvbixvdmVybGluZS10aGlja25lc3MscGFub3NlLTEscGF0aCxwYXRoTGVuZ3RoLHBvaW50cyxwcmVzZXJ2ZUFzcGVjdFJhdGlvLHIscmVmWCxyZWZZLHJlcGVhdENvdW50LHJlcGVhdER1cixyZXF1aXJlZEV4dGVuc2lvbnMscmVxdWlyZWRGZWF0dXJlcyxyZXN0YXJ0LHJvdGF0ZSxyeCxyeSxzbG9wZSxzdGVtaCxzdGVtdixzdG9wLWNvbG9yLHN0b3Atb3BhY2l0eSxzdHJpa2V0aHJvdWdoLXBvc2l0aW9uLHN0cmlrZXRocm91Z2gtdGhpY2tuZXNzLHN0cm9rZSxzdHJva2UtZGFzaGFycmF5LHN0cm9rZS1kYXNob2Zmc2V0LHN0cm9rZS1saW5lY2FwLHN0cm9rZS1saW5lam9pbixzdHJva2UtbWl0ZXJsaW1pdCxzdHJva2Utb3BhY2l0eSxzdHJva2Utd2lkdGgsc3lzdGVtTGFuZ3VhZ2UsdGFyZ2V0LHRleHQtYW5jaG9yLHRvLHRyYW5zZm9ybSx0eXBlLHUxLHUyLHVuZGVybGluZS1wb3NpdGlvbix1bmRlcmxpbmUtdGhpY2tuZXNzLHVuaWNvZGUsdW5pY29kZS1yYW5nZSx1bml0cy1wZXItZW0sdmFsdWVzLHZlcnNpb24sdmlld0JveCx2aXNpYmlsaXR5LHdpZHRoLHdpZHRocyx4LHgtaGVpZ2h0LHgxLHgyLHhsaW5rOmFjdHVhdGUseGxpbms6YXJjcm9sZSx4bGluazpyb2xlLHhsaW5rOnNob3cseGxpbms6dGl0bGUseGxpbms6dHlwZSx4bWw6YmFzZSx4bWw6bGFuZyx4bWw6c3BhY2UseG1sbnMseG1sbnM6eGxpbmsseSx5MSx5Mix6b29tQW5kUGFuIiwKITApLEg9Zi5leHRlbmQoe30sdyxtLHMpLGU7KGZ1bmN0aW9uKGEpe2lmKGEuZG9jdW1lbnQmJmEuZG9jdW1lbnQuaW1wbGVtZW50YXRpb24pYT1hLmRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudCgiaW5lcnQiKTtlbHNlIHRocm93IHUoIm5vaW5lcnQiKTt2YXIgZD0oYS5kb2N1bWVudEVsZW1lbnR8fGEuZ2V0RG9jdW1lbnRFbGVtZW50KCkpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5Iik7MT09PWQubGVuZ3RoP2U9ZFswXTooZD1hLmNyZWF0ZUVsZW1lbnQoImh0bWwiKSxlPWEuY3JlYXRlRWxlbWVudCgiYm9keSIpLGQuYXBwZW5kQ2hpbGQoZSksYS5hcHBlbmRDaGlsZChkKSl9KSh5KTtmLm1vZHVsZSgibmdTYW5pdGl6ZSIsW10pLnByb3ZpZGVyKCIkc2FuaXRpemUiLGZ1bmN0aW9uKCl7dmFyIGE9ITE7dGhpcy4kZ2V0PVsiJCRzYW5pdGl6ZVVyaSIsZnVuY3Rpb24oZCl7YSYmZi5leHRlbmQocixJKTtyZXR1cm4gZnVuY3Rpb24oYSl7dmFyIGM9CltdO0IoYSx0KGMsZnVuY3Rpb24oYSxiKXtyZXR1cm4hL151bnNhZmU6Ly50ZXN0KGQoYSxiKSl9KSk7cmV0dXJuIGMuam9pbigiIil9fV07dGhpcy5lbmFibGVTdmc9ZnVuY3Rpb24oZCl7cmV0dXJuIGYuaXNEZWZpbmVkKGQpPyhhPWQsdGhpcyk6YX19KTtmLm1vZHVsZSgibmdTYW5pdGl6ZSIpLmZpbHRlcigibGlua3kiLFsiJHNhbml0aXplIixmdW5jdGlvbihhKXt2YXIgZD0vKChmdHB8aHR0cHM/KTpcL1wvfCh3d3dcLil8KG1haWx0bzopP1tBLVphLXowLTkuXyUrLV0rQClcUypbXlxzLjssKCl7fTw+Ilx1MjAxZFx1MjAxOV0vaSxiPS9ebWFpbHRvOi9pO3JldHVybiBmdW5jdGlvbihjLGUpe2Z1bmN0aW9uIGcoYSl7YSYmcC5wdXNoKEEoYSkpfWZ1bmN0aW9uIG0oYSxiKXtwLnB1c2goIjxhICIpO2YuaXNEZWZpbmVkKGUpJiZwLnB1c2goJ3RhcmdldD0iJyxlLCciICcpO3AucHVzaCgnaHJlZj0iJyxhLnJlcGxhY2UoLyIvZywiJnF1b3Q7IiksJyI+Jyk7ZyhiKTtwLnB1c2goIjwvYT4iKX0KaWYoIWMpcmV0dXJuIGM7Zm9yKHZhciBsLHE9YyxwPVtdLGgsbjtsPXEubWF0Y2goZCk7KWg9bFswXSxsWzJdfHxsWzRdfHwoaD0obFszXT8iaHR0cDovLyI6Im1haWx0bzoiKStoKSxuPWwuaW5kZXgsZyhxLnN1YnN0cigwLG4pKSxtKGgsbFswXS5yZXBsYWNlKGIsIiIpKSxxPXEuc3Vic3RyaW5nKG4rbFswXS5sZW5ndGgpO2cocSk7cmV0dXJuIGEocC5qb2luKCIiKSl9fV0pfSkod2luZG93LHdpbmRvdy5hbmd1bGFyKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9YW5ndWxhci1zYW5pdGl6ZS5taW4uanMubWFwCg=='></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-select/0.13.2/select.css">
<link rel="stylesheet" href="/css/selectize.css">
<script>
	var app = angular.module('app', ['ui.select', 'ngSanitize'])
	.config(function($interpolateProvider, uiSelectConfig){
		$interpolateProvider.startSymbol('<%').endSymbol('%>');
		uiSelectConfig.theme = 'selectize';
	})
	.controller('quickSaleCtrl', function($scope) {
		$scope.quoteData = {
			supCosts: '0',
			adType: -1
		};
		$scope.entries = [{
			id: -1,
			productId: -1,
			quantity: 1,
			unitPrice: 0,
			discount: 0,
			description: ''
		}];
		$scope.vatValues = {};
		$scope.adTypes = {};


		$scope.searchProductResults = [];

		$scope.payment_notes = {
			500: 0,
			200: 0,
			100: 0,
			50: 0,
			20: 0,
			10: 0,
			5: 0
		};
		$scope.payment_coins = {
			200: 0,
			100: 0,
			50: 0,
			20: 0,
			10: 0,
			5: 0,
			2: 0,
			1: 0,
		};

		$scope.step = 1;

		$scope.receiptEnabled = false;

		$scope.paymentData = {
			paymentMethod: -1,
			nonCashTotal: 0,
			date: getCurrentDate(),
			notes: '',
			checkedByManagement: false,
			outToBank: false
		};

		$scope.increaseNote = function(value) {
			$scope.payment_notes[value]++;
		};

		$scope.increaseCoin = function(value) {
			$scope.payment_coins[value]++;
		};

		$scope.decreaseNote = function(value) {
			$scope.payment_notes[value]--;
		};

		$scope.decreaseCoin = function(value) {
			$scope.payment_coins[value]--;
		};

		ajaxRequest(
			'get_quick_sell',
			{},
			function(data) {
				$scope.adTypes = data.adTypes;
				$scope.vats = data.vats;
				$scope.vatValues = data.vatValues;

				$scope.quoteData.vat = "{{ Settings::setting('defaultVat') }}";

				$scope.$apply();

				setTimeout(function() {
					$('#adType').select2();
				}, 10);
			}
		);

		$scope.refreshProductResults = function(query) {
			if (query == '') {
				if ($scope.searchProductResults.length == 0)
					$scope.searchProductResults = [];
				return;
			}

			ajaxRequest(
				'search_product',
				{
					query: query
				},
				function(results) {
					$scope.searchProductResults = results;
					$scope.$apply();
				}
			);
		};

		$scope.updateProductRow = function(item, model, entry) {
			entry.productId = item.id;
			entry.productName = item.text;
			entry.unitPrice = item.salesPrice;
		};

		$scope.addNewEntry = function() {
			$scope.entries.push({
				id: -1,
				productId: -1,
				quantity: 1,
				unitPrice: 0,
				discount: 0,
				description: ''
			});
		};

		$scope.deleteEntry = function(entry) {
			$scope.entries.splice($scope.entries.indexOf(entry), 1);
		};

		$scope.getSubTotal = function() {
			var total = 0;
			$.each($scope.entries, function(i, e) {
				total += (e.unitPrice * e.quantity) * (1 - (e.discount/100));
			});
			return total;
		};

		$scope.getVat = function() {
			return $scope.getSubTotal() * ($scope.parseFloat($scope.vatValues[$scope.quoteData.vat]) / 100);
		};

		$scope.getTotal = function() {
			return $scope.getSubTotal() + $scope.getVat() + $scope.parseFloat($scope.quoteData.supCosts);
		};

		$scope.parseFloat = function(input) {
			if (!input || input == '')
				return 0;

			return parseFloat(input);
		};

		$scope.toggleReceipt = function() {
			$scope.receiptEnabled = !$scope.receiptEnabled;
		};

		$scope.getReceived = function() {
			return parseFloat($scope.paymentData.nonCashTotal) + parseFloat($scope.getCashTotal());
		};

		$scope.getCashTotal = function() {
			// Here we go...
			var total = 0;
			total += $scope.payment_notes[500] * 500;
			total += $scope.payment_notes[200] * 200;
			total += $scope.payment_notes[100] * 100;
			total += $scope.payment_notes[50] * 50;
			total += $scope.payment_notes[20] * 20;
			total += $scope.payment_notes[10] * 10;
			total += $scope.payment_notes[5] * 5;

			total += $scope.payment_coins[200] * 2;
			total += $scope.payment_coins[100] * 1;
			total += $scope.payment_coins[50] * 0.5;
			total += $scope.payment_coins[20] * 0.2;
			total += $scope.payment_coins[10] * 0.1;
			total += $scope.payment_coins[5] * 0.05;
			total += $scope.payment_coins[2] * 0.02;
			total += $scope.payment_coins[1] * 0.01;
			return total;
		};

		$scope.saveQuickSale = function() {

			if ($scope.paymentData.paymentMethod == -1) {
				showError('Please select a payment method before confirming the sale');
				return;
			}
			if (($scope.getTotal() - $scope.getReceived()) > 0.1) {
				showError('The total of the quote doesn\'t equal the total of the payment.');
				return;
			}

			var valid = true;
			angular.forEach($scope.entries, function(entry) {
				if (entry.productId == -1)
					valid = false;
			});
			if (!valid) {
				showError('Please make sure all the entries have a selected product');
				return;
			}

			confirmDialog(
				'Are you sure?',
				'Are you sure you want to confirm this purchase? The quote will be automatically generated.',
				function() {
					ajaxRequest(
						'create_quick_sale',
						{
							quoteData: $scope.quoteData,
							entries: $scope.entries,
							paymentData: $scope.paymentData,
							paymentNotes: $scope.payment_notes,
							paymentCoins: $scope.payment_coins
						},
						function(data) {
							if (data.success) {
								if ($scope.receiptEnabled)
									window.open('/quotepdf/' + data.quoteId + '/receipt');
								
								location.assign('/quotes/' + data.quoteId + '/edit');
							} else {
								showError('Something went wrong. Please contact us for more information.');
							}
						}
					);
				}
			);
		};

		$scope.nextStep = function() {
			if ($scope.step == 1 && $scope.quoteData.adType == -1) {
				showError('Please select an advertisement type');
				return;
			}
			$scope.step++;
		};

		$scope.prevStep = function() {
			$scope.step--;
		}
	});


app.directive('tabisnewentry', function() {
	return {
		restrict: 'A',
		link: function(scope, element, attrs) {
			$(element).on('keydown', function(event) {
				if (event.which == 9) { // tab
					// Only react if its the last one in the array
					if (!scope.$last) return;
					scope.entries.push(
					{
						id: -1,
						productId: -1,
						quantity: 1,
						unitPrice: 0,
						discount: 0,
						description: ''
					}
					);
					scope.$apply();
					setTimeout(function() {
						$('#quote_entries input[product-select]').last().select2('open');
					}, 50);

					event.preventDefault();
				}
			});
		}
	};
});

app.filter('currency', ['$filter', function($filter) {
	return function(input) {
		var curSymbol = '€ ';
		var decPlaces = 2;
		var thouSep = '';
		var decSep = '.';

		// Check for invalid inputs
		var out = isNaN(input) || input === '' || input === null ? 0.0 : input;

		//Deal with the minus (negative numbers)
		var minus = input < 0;
		out = Math.abs(out);
		out = $filter('number')(out, decPlaces);

		// Replace the thousand and decimal separators.  
		// This is a two step process to avoid overlaps between the two
		if(thouSep != ",") out = out.replace(/\,/g, "T");
		if(decSep != ".") out = out.replace(/\./g, "D");
		out = out.replace(/T/g, thouSep);
		out = out.replace(/D/g, decSep);

		// Add the minus and the symbol
		if(minus){
			return "-" + out;
		}else{
			return out;
		}
	}
}]);

$(function() {
	$('#payMethod').select2({
		placeholder: 'Select a payment method...',
	}).on('change', function(event) {
		$('#payMethod').scope().paymentData.paymentMethod = $('#payMethod option:selected').val();
	});
});
</script>
@stop

@section('stylesheets')
<style>
	.payment_notes_coins td {
		width: 6%;
		padding: 1px 3px 1px 3px;
		text-align: center;
		font-weight: bold;
		font-size: 9pt;
	}

	.payment_notes_coins input {
		width: 100%;
		text-align: center;
		margin-top: -3px;
	}

	.payment_notes_coins button {
		width: 100%;
		height: 30px;
		padding: 0;
	}

	.payment_notes_coins button.btn-green {
		border-bottom-left-radius: 0;
		border-bottom-right-radius: 0;
	}

	.payment_notes_coins button.btn-red {
		border-top-left-radius: 0;
		border-top-right-radius: 0;
		margin-top: -3px;
	}

	table.form label {
		font-weight: bold;
	}

	#quote_entries td {
		overflow: visible;
	}
</style>
@stop

@section('content')
<div ng-app='app' ng-controller='quickSaleCtrl'>
	<div class='bit-2' ng-show='step==1'>
		<div class="container">
			<div class="container_title blue">
				<i class="fa fa-info"></i> General information
			</div>
			<div class="container_content">
				<tabl
				e class='form'>
					<tr>
						<td style='width: 170px;'>Advertising source</td>
						<td style='width: 100%;'>
							<select id='adType' style='width: 100%;' ng-model='quoteData.adType'>
								@foreach(AdType::orderBy('type')->get() as $adType)
								<option value='{{ $adType->id }}'>{{ $adType->type}}</option>
								@endforeach
							</select>
						</td>
					</tr>
					<tr>
						<td></td>
						<td>
							<br><br>
							<button class="btn btn-green" ng-click='nextStep()'><i class="fa fa-check"></i> Continue</button>
						</td>
					</tr>
				</table>
			</div>
		</div>
	</div>
	<div class="bit-1" ng-show='step==2'>
		<div class="container">
			<div class="container_title orange">
				<i class="fa fa-list"></i> Quote entries
			</div>
			<div class="container_content nop" style='overflow: visible; max-height: none;'>
				<table class="data" id='quote_entries'>
					<tr>
						<th style='width: 40%;'>Product</th>
						<th style='width: 60%;'>Description</th>
						<th style='width: 70px;'>Quantity</th>
						<th style='width: 110px;'>Unit price</th>
						<th style='width: 80px;'>Discount</th>
						<th style='width: 110px;'>Total</th>
						<th style='width: 50px;'></th>
					</tr>
					<tr ng-repeat='entry in entries'>
						<td>
							<ui-select ng-model="entry.productId" style='width: 100%;' on-select='updateProductRow($item, $model, entry)'>
							    <ui-select-match placeholder='Search a product...'>
							        <span ng-bind="$select.selected.name"></span>
							    </ui-select-match>
							    <ui-select-choices repeat="item.id as item in (searchProductResults | filter: $select.search) track by item.id" refresh='refreshProductResults($select.search)' refresh-delay='200'>
							        <span ng-bind="item.name"></span>
							    </ui-select-choices>
							</ui-select>
						</td>
						<td><input type='text' ng-model='entry.description'></td>
						<td><input type='text' ng-model='entry.quantity' class='ar'></td>
						<td><input type='text' ng-model='entry.unitPrice' class='euro'></td>
						<td><input type='text' ng-model='entry.discount' tabisnewentry class='percentage'></td>
						<td><input type="text" ng-value='(entry.unitPrice * entry.quantity) * ((100 - entry.discount)/100) | currency' class='euro' readonly></td>
						<td>
							<button class='btn btn-red btn-square' ng-click='deleteEntry(entry);' tabindex="-1">
								<i class="fa fa-minus"></i>
							</button>
						</td>
					</tr>
					<tr>
						<td colspan="6" style='border: 0;'></td>
						<td>
							<button class='btn btn-green btn-square' ng-click='addNewEntry();'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
					</tr>
				</table>
			</div>
		</div>
	</div>
	<div class="bit-75">
		<div class="container" ng-show='step == 3'>
			<div class="container_title blue">
				<i class="fa fa-dollar"></i> Payment
			</div>
			<div class="container_content">
				<table class="tlf" style='width: 100%;'>
					<tr>
						<td style='width: 26%;'><b>Payment Method</b></td>
						<td style='width: 90px;'><b>Non-cash</b></td>
						<td style='width: 35%;'><b>Notes</b></td>
					</tr>
					<tr>
						<td>
							<select id='payMethod' style='width: 100%;'>
								<option value='-1' disabled selected>Select a payment type...</option>
								@foreach(PayMethod::all() as $payMethod)
								<option value='{{ $payMethod->id }}'>{{ $payMethod->type }}</option>
								@endforeach
							</select>
						</td>
						<td><input type='text' class='euro fw' ng-model='paymentData.nonCashTotal'></td>
						<td><input type='text' class='fw' ng-model='paymentData.notes'></td>
					</tr>
				</table>
				<br><br>
				<table class='payment_notes_coins payment_notes' style='float: left;'>
					<tr>
						<td>&euro;500</td>
						<td>&euro;200</td>
						<td>&euro;100</td>
						<td>&euro;50</td>
						<td>&euro;20</td>
						<td>&euro;10</td>
						<td>&euro;5</td>
						<td>&euro;2</td>
						<td>&euro;1</td>
						<td>&euro;0,50</td>
						<td>&euro;0,20</td>
						<td>&euro;0,10</td>
						<td>&euro;0,05</td>
						<td>&euro;0,02</td>
						<td>&euro;0,01</td>
					</tr>
					<tr>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(500)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(200)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(100)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(50)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(20)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(10)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseNote(5)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(200)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(100)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(50)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(20)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(10)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(5)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(2)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-green" ng-click='increaseCoin(1)' tabindex='-1'>
								<i class="fa fa-plus"></i>
							</button>
						</td>
					</tr>
					<tr>
						<td><input type='text' ng-model='payment_notes[500]'></td>
						<td><input type='text' ng-model='payment_notes[200]'></td>
						<td><input type='text' ng-model='payment_notes[100]'></td>
						<td><input type='text' ng-model='payment_notes[50]'></td>
						<td><input type='text' ng-model='payment_notes[20]'></td>
						<td><input type='text' ng-model='payment_notes[10]'></td>
						<td><input type='text' ng-model='payment_notes[5]'></td>
						<td><input type='text' ng-model='payment_coins[200]'></td>
						<td><input type='text' ng-model='payment_coins[100]'></td>
						<td><input type='text' ng-model='payment_coins[50]'></td>
						<td><input type='text' ng-model='payment_coins[20]'></td>
						<td><input type='text' ng-model='payment_coins[10]'></td>
						<td><input type='text' ng-model='payment_coins[5]'></td>
						<td><input type='text' ng-model='payment_coins[2]'></td>
						<td><input type='text' ng-model='payment_coins[1]'></td>
					</tr>
					<tr>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(500)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(200)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(100)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(50)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(20)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(10)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseNote(5)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(200)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(100)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(50)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(20)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(10)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(5)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(2)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
						<td>
							<button class="btn btn-red" ng-click='decreaseCoin(1)' tabindex='-1'>
								<i class="fa fa-minus"></i>
							</button>
						</td>
					</tr>
				</table>
				<br clear='both'>
			</div>
		</div>
	</div>
	<div class="bit-4" ng-show='step == 2 || step == 3'>
		<div class="container fl">
			<div class="container_title orange">
				<i class="fa fa-plus"></i> Totals
			</div>
			<div class="container_content nop">
				<table class='data smallrows'>
					<tr>
						<td style='width: 50%;'><label>Subtotal</label></td>
						<td style='width: 50%;' class='ar'><% getSubTotal() | currency %></td>
					</tr>
					<tr>
						<td>
							<select ng-model='quoteData.vat' ng-options='k as v for (k,v) in vats' class='fw'></select>
						</td>
						<td class='ar'>
							<% getVat() | currency %>
						</td>
					</tr>
					<tr>
						<td><label>Extra costs</label></td>
						<td>
							<input type='text' ng-model='quoteData.supCosts' class='euro' style='width: 100%;'>
						</td>
					</tr>
					<tr>
						<td><label>Total</label></td>
						<td class='bold underlined ar' style='font-size: 15pt;'>&euro; <% getTotal() | currency %></td>
					</tr>
					<tr>
						<td><label>Payment total</label></td>
						<td class='bold underlined ar' style='font-size: 14px;'>&euro; <% getReceived() | currency %></td>
					</tr>
					<tr>
						<td><label>Left to pay</label></td>
						<td class='bold underlined ar' style='font-size: 14px;'>&euro; <% (getTotal() - getReceived()) | currency %></td>
					</tr>
					<tr>
						<td colspan='2' ng-show='step == 2'>
							<button class="btn btn-green fw" ng-click='nextStep()'><i class="fa fa-check"></i> Continue</button>
						</td>
						<td colspan='2' ng-show='step == 3'>	
							<button class='btn btn-grey fl' ng-hide='receiptEnabled' style='width: 48%; height: 35px;' ng-click="toggleReceipt()" data-tooltip='Click to toggle the printing of the receipt'>
								<i class="fa fa-print"></i> Receipt off
							</button>
							<button class='btn btn-green fl' ng-show='receiptEnabled' style='width: 48%; height: 35px;' ng-click="toggleReceipt()">
								<i class="fa fa-print"></i> Receipt on
							</button>
							<button class='btn btn-green fr' style='width: 48%; height: 35px;' id='saveBtn' ng-click="saveQuickSale()">
								<i class="fa fa-save"></i> Confirm
							</button>
							<br>
						</td>	
					</tr>
				</table>
			</div>
		</div>
	</div>
</div>
@stop